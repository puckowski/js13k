class t{static create(){let t=new Float32Array(16);return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t}static perspective(t,e,o,n,r){let i=1/Math.tan(e/2),a=1/(n-r);return t[0]=i/o,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=i,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(r+n)*a,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*r*n*a,t[15]=0,t}static translate(t,e,o){let n=o[0],r=o[1],i=o[2];return e===t?(t[12]=e[0]*n+e[4]*r+e[8]*i+e[12],t[13]=e[1]*n+e[5]*r+e[9]*i+e[13],t[14]=e[2]*n+e[6]*r+e[10]*i+e[14],t[15]=e[3]*n+e[7]*r+e[11]*i+e[15]):(t[0]=e[0],t[1]=e[1],t[2]=e[2],t[3]=e[3],t[4]=e[4],t[5]=e[5],t[6]=e[6],t[7]=e[7],t[8]=e[8],t[9]=e[9],t[10]=e[10],t[11]=e[11],t[12]=e[0]*n+e[4]*r+e[8]*i+e[12],t[13]=e[1]*n+e[5]*r+e[9]*i+e[13],t[14]=e[2]*n+e[6]*r+e[10]*i+e[14],t[15]=e[3]*n+e[7]*r+e[11]*i+e[15]),t}}class e{constructor(t,e){this.width=t,this.height=e,this.data=new Uint8Array(t*e*4)}drawRectangle(t,e,o,n,r,i,a,s){for(let c=e;c<e+n;c++)for(let e=t;e<t+o;e++){let t=4*(c*this.width+e);this.data[t]=r,this.data[t+1]=i,this.data[t+2]=a,this.data[t+3]=s}return this}addRandomNoise(t,e,o,n=!1){const r=t=>{const e=Math.floor(.2*t),o=Math.max(0,t-e),n=Math.min(255,t+e);return Math.floor(Math.random()*(n-o+1))+o};for(let i=0;i<this.height;i+=8)for(let a=0;a<this.width;a+=8){const s=r(t),c=r(e),u=r(o);for(let t=0;t<8;t++)for(let e=0;e<8;e++){if(i+t>=this.height||a+e>=this.width)continue;let o=4*((i+t)*this.width+(a+e));n?(this.data[o]=s,this.data[o+1]=c,this.data[o+2]=u):(this.data[o]=Math.floor(.5*this.data[o]+.5*s),this.data[o+1]=Math.floor(.5*this.data[o+1]+.5*c),this.data[o+2]=Math.floor(.5*this.data[o+2]+.5*u)),this.data[o+3]=255}}return this}copyRows(t,e){const o=Math.floor(.25*this.height);t+=o;for(let n=0;n<o;n++)for(let r=0;r<this.width;r++){const i=4*((t-o+n)*this.width+r),a=4*((e+n)*this.width+r);this.data[a]=this.data[i],this.data[a+1]=this.data[i+1],this.data[a+2]=this.data[i+2],this.data[a+3]=this.data[i+3]}return this}getData(){return this.data}}const o={1:[[1,1,1,1,1,1,1,1,1,1],[1,2,0,0,0,0,0,0,0,1],[1,0,1,1,1,1,1,1,0,1],[1,3,1,0,0,0,0,1,0,1],[1,0,1,0,1,1,0,1,0,1],[1,0,1,0,0,1,0,1,0,1],[1,0,1,1,0,1,0,1,0,1],[1,0,0,0,0,1,0,1,0,1],[1,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1]],2:[[1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,2,1],[1,0,1,1,1,1,1,1,0,1],[1,0,1,0,0,0,0,1,3,1],[1,0,1,0,1,1,0,1,0,1],[1,0,1,0,0,1,0,1,0,1],[1,0,1,1,0,1,0,1,0,1],[1,0,0,0,0,1,0,1,0,1],[1,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,1]]};let n=!1,r=1,i=3,a=0,s=o[1];const c=new Map;c.set(1,2),c.set(2,1);let u,f=1,d=8,l=1,R=1;const h=document.getElementById("glCanvas"),g=h.getContext("webgl");g||(alert("WebGL not supported, falling back on experimental-webgl"),g=h.getContext("experimental-webgl")),g||alert("Your browser does not support WebGL"),g.enable(g.BLEND),g.blendFunc(g.SRC_ALPHA,g.ONE_MINUS_SRC_ALPHA);const p=new e(256,256);p.drawRectangle(0,0,86,32,63,62,62,255).drawRectangle(86,0,86,32,92,91,90,255).drawRectangle(172,0,86,32,63,62,62,255).drawRectangle(0,32,64,32,112,111,110,255).drawRectangle(64,32,64,32,80,79,79,255).drawRectangle(128,32,64,32,112,111,110,255).drawRectangle(192,32,64,32,80,79,79,255).copyRows(0,64).copyRows(32,96).copyRows(0,128).copyRows(32,160).copyRows(0,192).copyRows(32,224).addRandomNoise(85,84,84);let A=q(g,256,256,p);const m=new e(256,256);m.drawRectangle(0,0,128,32,98,74,58,255).drawRectangle(128,0,128,32,113,89,73,255).drawRectangle(0,32,128,32,113,64,48,255).drawRectangle(128,32,128,32,108,84,68,255).copyRows(0,64).copyRows(32,96).copyRows(0,128).copyRows(32,160).copyRows(0,192).copyRows(32,224).addRandomNoise(99,75,59);const x=new e(256,256);x.drawRectangle(0,0,86,32,146,135,121,255).drawRectangle(86,0,86,32,131,121,108,255).drawRectangle(172,0,86,32,146,135,121,255).drawRectangle(0,32,64,32,116,108,96,255).drawRectangle(64,32,64,32,102,94,84,255).drawRectangle(128,32,64,32,116,108,96,255).drawRectangle(192,32,64,32,102,94,84,255).copyRows(0,64).copyRows(32,96).copyRows(0,128).copyRows(32,160).copyRows(0,192).copyRows(32,224).addRandomNoise(90,48,16);const E=q(g,256,256,x),y=new e(256,256);y.addRandomNoise(0,105,62);const w=q(g,256,256,y),T=new e(256,256);T.drawRectangle(0,0,256,256,255,255,255,0).drawRectangle(112,32,16,16,0,0,0,255).drawRectangle(118,48,4,96,0,0,0,255).drawRectangle(76,76,88,4,0,0,0,255).drawRectangle(114,144,4,96,0,0,0,255).drawRectangle(122,144,4,96,0,0,0,255).drawRectangle(122,144,4,96,0,0,0,255);const F=q(g,256,256,T),b=new Map;function _(t,e,o){const n=function(t,e){return{positions:[t,0,e,t+1,0,e,t,1,e,t+1,1,e],textureCoordinates:[0,1,1,1,0,0,1,0],indices:[0,1,2,2,1,3]}}(e,o),r=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,r),t.bufferData(t.ARRAY_BUFFER,new Float32Array(n.positions),t.STATIC_DRAW);const i=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,i),t.bufferData(t.ARRAY_BUFFER,new Float32Array(n.textureCoordinates),t.STATIC_DRAW);const a=t.createBuffer();return t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,a),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(n.indices),t.STATIC_DRAW),{position:r,textureCoord:i,indices:a,vertexCount:n.indices.length}}function L(t,e,o,n){const r=t.getUniformLocation(e.program,"uColor");t.bindBuffer(t.ARRAY_BUFFER,o.position),t.vertexAttribPointer(e.attribLocations.vertexPosition,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(e.attribLocations.vertexPosition),t.bindBuffer(t.ARRAY_BUFFER,o.textureCoord),t.vertexAttribPointer(e.attribLocations.textureCoord,2,t.FLOAT,!1,0,0),t.enableVertexAttribArray(e.attribLocations.textureCoord),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,o.indices),t.uniformMatrix4fv(e.uniformLocations.modelViewMatrix,!1,n),t.activeTexture(t.TEXTURE0),t.bindTexture(t.TEXTURE_2D,F),t.uniform1i(e.uniformLocations.uSampler,0),t.uniform4f(r,0,0,0,0),t.drawElements(t.TRIANGLES,o.vertexCount,t.UNSIGNED_SHORT,0)}b.set(1,E),b.set(2,w);const C=function(t,e,o){const n=[],r=[];for(let r=0;r<=e;r++){const i=r*Math.PI/e,a=Math.sin(i),s=Math.cos(i);for(let e=0;e<=o;e++){const r=2*e*Math.PI/o,i=Math.sin(r),c=Math.cos(r)*a,u=s,f=i*a;n.push(t*c,t*u,t*f)}}for(let t=0;t<e;t++)for(let e=0;e<o;e++){const n=t*(o+1)+e,i=n+o+1;r.push(n,i,n+1,i,i+1,n+1)}return{positions:n,indices:r}}(.25,30,30),U=g.createBuffer();g.bindBuffer(g.ARRAY_BUFFER,U),g.bufferData(g.ARRAY_BUFFER,new Float32Array(C.positions),g.STATIC_DRAW);const v=g.createBuffer();g.bindBuffer(g.ELEMENT_ARRAY_BUFFER,v),g.bufferData(g.ELEMENT_ARRAY_BUFFER,new Uint16Array(C.indices),g.STATIC_DRAW);const B={position:U,indices:v,vertexCount:C.indices.length};function M(t,e,o){const n=t.createShader(e);return t.shaderSource(n,o),t.compileShader(n),t.getShaderParameter(n,t.COMPILE_STATUS)?n:(alert("An error occurred compiling the shaders: "+t.getShaderInfoLog(n)),t.deleteShader(n),null)}const P=function(t,e,o){const n=M(t,t.VERTEX_SHADER,e),r=M(t,t.FRAGMENT_SHADER,o),i=t.createProgram();return t.attachShader(i,n),t.attachShader(i,r),t.linkProgram(i),t.getProgramParameter(i,t.LINK_STATUS)?i:(alert("Unable to initialize the shader program: "+t.getProgramInfoLog(i)),null)}(g,"\nattribute vec4 aVertexPosition;\nattribute vec2 aTextureCoord;\nuniform mat4 uModelViewMatrix;\nuniform mat4 uProjectionMatrix;\nvarying highp vec2 vTextureCoord;\nvarying highp vec3 vFragPos;\n\nvoid main(void) {\ngl_Position = uProjectionMatrix * uModelViewMatrix * aVertexPosition;\nvTextureCoord = aTextureCoord;\nvFragPos = (uModelViewMatrix * aVertexPosition).xyz;\n}\n","\nvarying highp vec2 vTextureCoord;\nuniform sampler2D uSampler;\nuniform highp vec3 fogColor;\nuniform highp float fogNear;\nuniform highp float fogFar;\nvarying highp vec3 vFragPos;\nuniform highp vec4 uColor;\n\nvoid main(void) {\n    if (uColor.a != 0.0) {\n        gl_FragColor = uColor;\n    } else {\n        highp vec4 textureColor = texture2D(uSampler, vTextureCoord);\n        highp float fogDistance = length(vFragPos);\n        highp float fogFactor = smoothstep(fogNear, fogFar, fogDistance);\n        gl_FragColor = mix(textureColor, vec4(fogColor, 1.0), fogFactor);\n        gl_FragColor.a *= textureColor.a;  // Apply texture alpha\n    }\n}\n"),S={program:P,attribLocations:{vertexPosition:g.getAttribLocation(P,"aVertexPosition"),textureCoord:g.getAttribLocation(P,"aTextureCoord")},uniformLocations:{projectionMatrix:g.getUniformLocation(P,"uProjectionMatrix"),modelViewMatrix:g.getUniformLocation(P,"uModelViewMatrix"),uSampler:g.getUniformLocation(P,"uSampler"),fogColor:g.getUniformLocation(P,"fogColor"),fogNear:g.getUniformLocation(P,"fogNear"),fogFar:g.getUniformLocation(P,"fogFar"),uColor:g.getUniformLocation(P,"uColor")}};let D,N,I=Y(g);function Y(t){const e=[],o=[],n=[],r=[],i=[],a=[];let c=0;for(let t=0;t<s.length;t++)for(let r=0;r<s[t].length;r++)1===s[t][r]&&(e.push(r,0,t,r+1,0,t,r,1,t,r+1,1,t),o.push(0,0,1,0,0,1,1,1),n.push(c,c+1,c+2,c+2,c+1,c+3),c+=4,e.push(r,0,t+1,r+1,0,t+1,r,1,t+1,r+1,1,t+1),o.push(0,0,1,0,0,1,1,1),n.push(c,c+1,c+2,c+2,c+1,c+3),c+=4,e.push(r+1,0,t,r+1,0,t+1,r+1,1,t,r+1,1,t+1),o.push(0,0,1,0,0,1,1,1),n.push(c,c+1,c+2,c+2,c+1,c+3),c+=4,e.push(r,0,t,r,0,t+1,r,1,t,r,1,t+1),o.push(0,0,1,0,0,1,1,1),n.push(c,c+1,c+2,c+2,c+1,c+3),c+=4);for(let t=0;t<s.length;t++)for(let e=0;e<s[t].length;e++)r.push(e,0,t,e+1,0,t,e,0,t+1,e+1,0,t+1),i.push(0,0,1,0,0,1,1,1),a.push(c,c+1,c+2,c+2,c+1,c+3),c+=4;const u=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,u),t.bufferData(t.ARRAY_BUFFER,new Float32Array(e.concat(r)),t.STATIC_DRAW);const f=t.createBuffer();t.bindBuffer(t.ARRAY_BUFFER,f),t.bufferData(t.ARRAY_BUFFER,new Float32Array(o.concat(i)),t.STATIC_DRAW);const d=t.createBuffer();return t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,d),t.bufferData(t.ELEMENT_ARRAY_BUFFER,new Uint16Array(n.concat(a)),t.STATIC_DRAW),{position:u,textureCoord:f,indices:d,vertexCount:n.length+a.length,wallVertexCount:n.length,floorVertexCount:a.length}}function q(t,e,o,n){const r=t.createTexture();t.bindTexture(t.TEXTURE_2D,r);const i=n.getData();return t.texImage2D(t.TEXTURE_2D,0,t.RGBA,e,o,0,t.RGBA,t.UNSIGNED_BYTE,i),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),r}function z(e,o,n,r,i,a){e.clearColor(.53,.81,.98,1),e.clearDepth(1),e.enable(e.DEPTH_TEST),e.depthFunc(e.LEQUAL),e.clear(e.COLOR_BUFFER_BIT|e.DEPTH_BUFFER_BIT);const c=45*Math.PI/180,h=e.canvas.clientWidth/e.canvas.clientHeight,g=t.create();t.perspective(g,c,h,.1,100);const p=t.create();t.translate(p,p,[-f-.5,-1,-d]);{const t=3,r=e.FLOAT,i=!1,a=0,s=0;e.bindBuffer(e.ARRAY_BUFFER,n.position),e.vertexAttribPointer(o.attribLocations.vertexPosition,t,r,i,a,s),e.enableVertexAttribArray(o.attribLocations.vertexPosition)}{const t=2,r=e.FLOAT,i=!1,a=0,s=0;e.bindBuffer(e.ARRAY_BUFFER,n.textureCoord),e.vertexAttribPointer(o.attribLocations.textureCoord,t,r,i,a,s),e.enableVertexAttribArray(o.attribLocations.textureCoord)}e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,n.indices),e.useProgram(o.program),e.uniformMatrix4fv(o.uniformLocations.projectionMatrix,!1,g),e.uniformMatrix4fv(o.uniformLocations.modelViewMatrix,!1,p),e.uniform3f(o.uniformLocations.fogColor,.53,.81,.98),e.uniform1f(o.uniformLocations.fogNear,1),e.uniform1f(o.uniformLocations.fogFar,10),e.activeTexture(e.TEXTURE0),e.bindTexture(e.TEXTURE_2D,r),e.uniform1i(o.uniformLocations.uSampler,0),e.uniform4f(o.uniformLocations.uColor,0,0,0,0);{const t=n.wallVertexCount,o=e.UNSIGNED_SHORT,r=0;e.drawElements(e.TRIANGLES,t,o,r)}e.bindTexture(e.TEXTURE_2D,i);{const t=n.floorVertexCount,o=e.UNSIGNED_SHORT,r=2*n.wallVertexCount;e.drawElements(e.TRIANGLES,t,o,r)}const A=t.create();u=function(t,e,o,n,r=-.25){return[-t+o,r,-e+n+.5]}(f,d,l,R),t.translate(A,A,u),function(t,e,o,n,r){const i=t.getUniformLocation(e.program,"uColor");t.bindBuffer(t.ARRAY_BUFFER,o.position),t.vertexAttribPointer(e.attribLocations.vertexPosition,3,t.FLOAT,!1,0,0),t.enableVertexAttribArray(e.attribLocations.vertexPosition),t.bindBuffer(t.ELEMENT_ARRAY_BUFFER,o.indices),t.uniformMatrix4fv(e.uniformLocations.modelViewMatrix,!1,n),t.uniform4fv(i,r),t.drawElements(t.TRIANGLES,o.vertexCount,t.UNSIGNED_SHORT,0)}(e,o,a,A,[0,1,0,1]);for(let t=0;t<s.length;t++)for(let n=0;n<s[t].length;n++)if(3===s[t][n]){L(e,o,_(e,n,t),p)}}function V(t){switch(r){case 1:A=q(g,256,256,p);break;case 2:A=q(g,256,256,m)}s=t,I=Y(g);const{x:e,y:o}=function(){for(let t=0;t<s.length;t++)for(let e=0;e<s[t].length;e++)if(2===s[t][e])return{x:e,y:t}}();l=e,R=o,z(g,S,I,A,b.get(r),B),z(g,S,I,A,b.get(r),B)}function k(){const t=document.getElementById("status");i<=0?(n=!1,t.innerText="You lost!"):t.innerText=2===a?"You won!":"Lives: "+i;const e=document.createElement("button");e.innerText="Manual",e.style="color:white;background-color:#2222;margin-left:1rem;",e.onclick=()=>{const t=document.getElementById("overlay");t.hidden?t.removeAttribute("hidden"):t.setAttribute("hidden",!0)},t.appendChild(e)}function G(t,e){const o=document.getElementById(t);!function(t){if(t)document.documentElement.style.setProperty("--intensity",255);else{let t=getComputedStyle(document.documentElement).getPropertyValue("--intensity").trim(),e=Math.max(parseInt(t)-30,135);document.documentElement.style.setProperty("--intensity",e)}}(o.hidden),o.removeAttribute("hidden"),o.innerText=e,D&&(N!==o&&N.setAttribute("hidden",!0),clearTimeout(D)),D=setTimeout((()=>{o.setAttribute("hidden",!0)}),3e3),N=o,k()}function O(){const t=new(window.AudioContext||window.webkitAudioContext),e=[{frequency:440,duration:1,position:{x:1,y:0,z:0}},{frequency:494,duration:.5,position:{x:-1,y:0,z:0}},{frequency:523,duration:.25,position:{x:0,y:0,z:1}},{frequency:392,duration:.25,position:{x:0,y:0,z:-1}},{frequency:659,duration:.5,position:{x:1,y:0,z:1}},{frequency:698,duration:.25,position:{x:-1,y:0,z:1}},{frequency:330,duration:.25,position:{x:1,y:0,z:-1}},{frequency:349,duration:1,position:{x:0,y:1,z:0}},{frequency:311,duration:.5,position:{x:0,y:-1,z:0}},{frequency:587,duration:.25,position:{x:1,y:1,z:0}},{frequency:261,duration:.25,position:{x:-1,y:-1,z:0}},{frequency:349,duration:.5,position:{x:0,y:1,z:1}},{frequency:440,duration:.25,position:{x:0,y:-1,z:1}},{frequency:493,duration:.25,position:{x:1,y:-1,z:0}},{frequency:523,duration:1,position:{x:-1,y:1,z:0}},{frequency:294,duration:.25,position:{x:1,y:0,z:-1}},{frequency:329,duration:.25,position:{x:-1,y:0,z:-1}},{frequency:370,duration:.5,position:{x:0,y:0,z:2}},{frequency:415,duration:.25,position:{x:0,y:0,z:-2}},{frequency:466,duration:.25,position:{x:1,y:1,z:1}},{frequency:523,duration:.5,position:{x:-1,y:1,z:-1}},{frequency:587,duration:.25,position:{x:1,y:-1,z:1}},{frequency:659,duration:.25,position:{x:-1,y:-1,z:1}},{frequency:698,duration:1,position:{x:1,y:0,z:2}}];let o=0;for(let n=0;n<e.length;n++){const r=e[n];X(t,r.frequency,r.duration,r.position,o),o+=r.duration}n&&setTimeout(O,1e3*o)}function X(t,e,o,r,i){if(!n)return;const a=t.createOscillator();a.type="sine",a.frequency.setValueAtTime(e,t.currentTime+i);const s=t.createGain();s.gain.setValueAtTime(.05,t.currentTime+i);const c=new PannerNode(t,{panningModel:"HRTF",distanceModel:"inverse",positionX:r.x,positionY:r.y,positionZ:r.z,refDistance:1,maxDistance:10,rolloffFactor:2}),u=t.createBiquadFilter();u.type="lowpass",u.frequency.setValueAtTime(1e3,t.currentTime+i),a.connect(s),s.connect(u),u.connect(c),c.connect(t.destination),a.start(t.currentTime+i),a.stop(t.currentTime+i+o)}document.addEventListener("keydown",(t=>{if(i<=0)return;n||(n=!0,O());const e=Math.floor(2*Math.random())+1;if("ArrowUp"!==t.key||0!==s[d-1][f]&&2!==s[d-1][f])if("ArrowDown"!==t.key||0!==s[d+1][f]&&2!==s[d+1][f])if("ArrowLeft"!==t.key||0!==s[d][f-1]&&2!==s[d][f-1])if("ArrowRight"!==t.key||0!==s[d][f+1]&&2!==s[d][f+1]){if(3===s[d-1][f])if("a"===t.key)switch(e){case 1:s[d-1][f]=0,a++,G("win","Scissors");break;case 2:i--,G("defeat","Paper")}else if("s"===t.key)switch(e){case 1:s[d-1][f]=0,a++,G("win","Rock");break;case 2:i--,G("defeat","Scissors")}else if("d"===t.key)switch(e){case 1:s[d-1][f]=0,a++,G("win","Paper");break;case 2:G("defeat","Rock")}}else f++;else f--;else d++;else d--;if(2===s[d][f]){const t=c.get(r);r=t,V(o[String(r)])}else z(g,S,I,A,b.get(r),B)})),k(),z(g,S,I,A,b.get(r),B);